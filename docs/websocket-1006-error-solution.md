# WebSocket 1006 错误解决方案

## 概述

本文档描述了针对 Ratel 在线扑克游戏中 WebSocket 1006 错误的解决方案实现。

## 实现的功能

### 1. 心跳机制
- **心跳间隔**：30秒发送一次心跳包
- **超时检测**：10秒内未收到响应视为超时
- **自动处理**：超时后自动触发重连

### 2. 自动重连机制
- **重连次数**：最多尝试3次
- **重连延迟**：2秒后开始重连
- **状态恢复**：重连成功后自动恢复游戏状态

### 3. 连接状态显示
- **实时状态**：右上角显示当前连接状态
- **状态类型**：
  - 🟢 已连接（绿色）
  - 🟡 连接中（黄色）
  - 🟠 重连中（橙色）
  - 🔴 已断开（红色）
  - ❌ 连接错误（红色）
- **延迟显示**：连接正常时显示网络延迟
- **点击查看详情**：点击状态栏可查看详细连接信息

### 4. 网络监控
- **网络质量检测**：每5秒检测一次网络质量
- **质量等级**：
  - 🟢 网络良好
  - 🟡 网络一般
  - 🔴 网络较差
  - ⚫ 已离线
- **自动提醒**：网络质量变差时自动提醒用户

### 5. 游戏状态保存与恢复
- **自动保存**：断线时自动保存游戏状态
- **本地存储**：使用 localStorage 保存，防止页面刷新丢失
- **有效期**：5分钟内的状态可以恢复
- **恢复内容**：
  - 用户信息
  - 房间信息
  - 游戏进度

### 6. 操作缓存
- **离线操作**：断线期间的操作会被缓存
- **队列管理**：最多缓存50个操作
- **自动执行**：重连后自动执行缓存的操作

### 7. 友好的错误提示
- **1006错误特殊处理**：显示友好的错误说明
- **可能原因提示**：列出可能的断线原因
- **操作建议**：提供明确的操作建议

## 使用说明

### 自动功能
以下功能会自动运行，无需用户干预：
1. 心跳检测
2. 断线重连
3. 状态保存与恢复
4. 网络质量监控

### 用户交互
1. **查看连接详情**：点击右上角的连接状态图标
2. **手动重连**：如果自动重连失败，刷新页面即可
3. **清除自动操作**：在浏览器控制台执行：
   ```javascript
   localStorage.removeItem('ratel_auto_pvp_action');
   ```

### 开发者配置
在代码中可以调整以下参数：
```javascript
// 心跳配置
this.heartbeatDelay = 30000; // 心跳间隔（毫秒）
this.heartbeatTimeoutDelay = 10000; // 心跳超时（毫秒）

// 重连配置
this.maxReconnectAttempts = 3; // 最大重连次数
this.reconnectDelay = 2000; // 重连延迟（毫秒）

// 缓存配置
this.maxQueueSize = 50; // 最大缓存操作数
```

## 测试方法

### 模拟断线
1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 将网络状态改为 Offline
4. 观察自动重连行为

### 模拟网络延迟
1. 在 Network 标签中选择网络节流
2. 选择 "Slow 3G" 或自定义延迟
3. 观察心跳超时和网络质量提示

## 故障排查

### 连接失败
1. 检查服务器地址是否正确
2. 确认服务器正在运行
3. 检查防火墙设置
4. 对于 WSS 连接，检查 SSL 证书

### 重连失败
1. 检查网络连接
2. 查看浏览器控制台错误信息
3. 确认服务器没有拒绝连接
4. 手动刷新页面重试

### 状态恢复失败
1. 检查 localStorage 是否被禁用
2. 确认断线时间未超过5分钟
3. 查看控制台是否有错误信息

## 注意事项

1. **浏览器兼容性**：需要支持 WebSocket 的现代浏览器
2. **网络要求**：稳定的网络连接可获得最佳体验
3. **服务器支持**：服务器需要正确处理心跳包
4. **隐私模式**：浏览器隐私模式可能影响状态保存功能 